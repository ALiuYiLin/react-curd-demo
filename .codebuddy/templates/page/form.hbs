import { useEffect } from 'react'
import { Form as AntdForm, Input, InputNumber, Modal, Button } from 'antd'
import { STORE } from '@/store'
import { ModalMode } from '@/store/{{pageName}}/types'

export function {{EntityName}}FormModal() {
  const { currentUser, modalMode } = STORE.{{EntityName}}Store.useUI()
  const { isModalOpen, isViewMode, modalTitle } = STORE.{{EntityName}}Store.useDerived()
  const { handleCancel } = STORE.{{EntityName}}Store.useOptions()
  const { add{{EntityName}}, update{{EntityName}} } = STORE.{{EntityName}}Store.useBase()

  const [form] = AntdForm.useForm()

  useEffect(() => {
    if (modalMode === ModalMode.VIEW || modalMode === ModalMode.EDIT) {
      form.setFieldsValue(currentUser)
    } else if (modalMode === ModalMode.ADD) {
      form.resetFields()
    }
  }, [modalMode, currentUser, form])

  const handleSubmit = async () => {
    try {
      const values = await form.validateFields()
      
      if (modalMode === ModalMode.EDIT && currentUser) {
        await update{{EntityName}}(currentUser.id, values)
      } else if (modalMode === ModalMode.ADD) {
        await add{{EntityName}}(values)
      }
      
      handleCancel()
      form.resetFields()
    } catch (error) {
      console.error('操作失败:', error)
    }
  }

  const handleModalCancel = () => {
    handleCancel()
    form.resetFields()
  }

  return (
    <Modal
      title={modalTitle}
      open={isModalOpen}
      onOk={isViewMode ? handleModalCancel : handleSubmit}
      onCancel={handleModalCancel}
      okText={isViewMode ? "关闭" : "确定"}
      cancelText={isViewMode ? undefined : "取消"}
      footer={isViewMode ? [
        <Button key="close" onClick={handleModalCancel}>
          关闭
        </Button>
      ] : undefined}
    >
      <AntdForm
        form={form}
        layout="vertical"
        name="{{pageName}}Form"
        disabled={isViewMode}
      >
{{#each formFields}}
        <AntdForm.Item
          label="{{{label}}}"
          name="{{{field}}}"
{{#if rules}}
          rules={ {{{rules}}} }
{{/if}}
        >
{{#ifEquals component "Input"}}
          <Input placeholder="请输入{{{label}}}" />
{{/ifEquals}}
{{#ifEquals component "InputNumber"}}
          <InputNumber 
            placeholder="请输入{{{label}}}" 
            style=\{{ width: '100%' }}
{{#if min}}
            min={ {{{min}}} }
{{/if}}
{{#if max}}
            max={ {{{max}}} }
{{/if}}
          />
{{/ifEquals}}
        </AntdForm.Item>

{{/each}}
      </AntdForm>
    </Modal>
  )
}
